---
layout: post
title: MySQL 主从复制原理

date: 2021-02-01 17:09:11.000000000 +09:00
---

### MySQL 主从复制原理

mysql是开发中普遍使用的数据库，在实际使用中高并发或者宕机情况会造成数据丢失或访问效率下降，为了保证可靠性需要采用一些辅助技术

#### 什么是主从复制

主从复制允许将来自一个mysql数据库的数据复制到一个或多个数据库中，是将主数据库的ddl和dml操作通过二进制日志传输到从数据库，然后在从数据库上执行这些日志，实现主从数据库数据的一致。

#### mysql主从复制原理

>* MySQL主库在事务提交时把数据变更作为事件记录在二进制日志Binary log中
>
>* master推送二进制日志文件Binlog中的事件到从库的中继日志Relay Log中，之后从库根据中继日志重做数据变更操作，通过逻辑复制来达到主库和从库的数据一致性
>
>* MySQL通过三个线程完成主从库间的数据复制，Binlog Dump线程跑在主库上，I/O线程和SQL线程跑在从库上
>
>* 当在从库上启动复制是，首先创建I/O线程连接主库，主库创建Binlogdump线程读取数据库事件并发送给I/O线程，I/O线程获取到事件数据后更新到从库的中继日志Relay Log中，从库上的SQL线程读取Relay Log中更新的数据库事件并应用
![在这里插入图片描述](https://img-blog.csdnimg.cn/20210202145853231.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMyNDU4MjU3,size_16,color_FFFFFF,t_70)



#### 搭建

主数据库

* 修改主数据库配置文件my.cnf

  > [mysqld]
  > *## 设置server_id，同一局域网中需要唯一*
  > server_id=101
  > *## 指定不需要同步的数据库名称*
  > binlog-ignore-db=mysql
  > *## 开启二进制日志功能*
  > log-bin=mall-mysql-bin
  > *## 设置二进制日志使用内存大小（事务）*
  > binlog_cache_size=1M
  > *## 设置使用的二进制日志格式（mixed,statement,row）*
  > binlog_format=mixed
  > *## 二进制日志过期清理时间。默认值为0，表示不自动清理。*
  > expire_logs_days=7
  > *## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。*
  > *## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致*
  > slave_skip_errors=1062

* 重启数据库，创建数据同步用户

  > CREATE USER 'slave'@'%' IDENTIFIED BY '123456';
  > GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'slave'@'%';

从数据库

* my.cnf

 ```shell
 [mysqld]
 ## 设置server_id，同一局域网中需要唯一
 server_id=102
 ## 指定不需要同步的数据库名称
 binlog-ignore-db=mysql
 ## 开启二进制日志功能，以备Slave作为其它数据库实例的Master时使用
 log-bin=mall-mysql-slave1-bin
 ## 设置二进制日志使用内存大小（事务）
 binlog_cache_size=1M
 ## 设置使用的二进制日志格式（mixed,statement,row）
 binlog_format=mixed
 ## 二进制日志过期清理时间。默认值为0，表示不自动清理。
 expire_logs_days=7
 ## 跳过主从复制中遇到的所有错误或指定类型的错误，避免slave端复制中断。
 ## 如：1062错误是指一些主键重复，1032错误是因为主从数据库数据不一致
 slave_skip_errors=1062
 ## relay_log配置中继日志
 relay_log=mall-mysql-relay-bin
 ## log_slave_updates表示slave将复制事件写进自己的二进制日志
 log_slave_updates=1
 ## slave设置为只读（具有super权限的用户除外）
 read_only=1
 ```

连接主从数据库

* 从数据库中配置主从复制

  ```shell
  change master to master_host='192.168.6.132', master_user='slave', master_password='123456', master_port=3307, master_log_file='mall-mysql-bin.000001', master_log_pos=617, master_connect_retry=30;
  ```

* 查看主从同步状态：

  ```
  show slave status \G;
  ```

* 开启同步

  ```shell
  start slave;
  ```

  
